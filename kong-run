#!/usr/bin/env bash
set -e

VOLUME="${1:-`pwd`/volume}"
VOLUME=$(readlink -mf "$VOLUME")
IMAGE="${2:-rakjin/kong}"

mkdir -p "$VOLUME"
CID=$(docker run -dp 127.0.0.1::22 -v "$VOLUME":/home/kong/volume "$IMAGE")
docker cp ~/.ssh/id_rsa     "$CID":/home/kong/.ssh/
docker cp ~/.ssh/id_rsa.pub "$CID":/home/kong/.ssh/
docker cp ~/.ssh/id_rsa.pub "$CID":/home/kong/.ssh/authorized_keys
docker exec "$CID" sh -c 'chown kong:kong /home/kong/.ssh/*'
SSH_PORT=$(docker port "$CID" 22 | cut -d ":" -f 2)
ssh -o LogLevel=quiet \
    -o UserKnownHostsFile=/dev/null \
    -o StrictHostKeyChecking=no \
    -p "$SSH_PORT" kong@127.0.0.1
